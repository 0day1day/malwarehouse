import sqlalchemy
from sqlalchemy import *
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base
import malware_sample_model
import utils
import os, sys



# Load configuration
config = utils.get_configuration("malwarehouse.cfg")
db_name = config.get('database', 'name')
option_base_dir = os.path.expanduser(config.get('settings', 'basedir'))
db_path = os.path.join(option_base_dir, db_name)
dir_path = option_base_dir

# Create the root directory if it does not exist
if not os.path.exists(dir_path):
    try:
        os.makedirs(dir_path)
        print "%s successfully created"%dir_path
    except Exception, err:
        print err
        sys.exit(1)

# Create the DB
if os.path.exists(db_path):
    print "\nINFO: %s already exists"%db_path
else:   
    try:
        url = "sqlite:///%s"%db_path
        engine = create_engine(url)
        print url
        engine.echo = True  # Try changing this to True and see what happens
        metadata = MetaData(engine)
        Base = malware_sample_model.Base
        Base.metadata.create_all(engine)
        print "%s successfully created"%db_name
    except Exception, err:
        print "%s-%s"%(Exception, err)
